{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - Food Metrics</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f7f7f7; padding-top: 50px; }
    .signup-container { max-width: 900px; margin: auto; background: white; padding: 20px;
      border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .header-logo { color: #F9850A; font-weight: bold; }
    .sidebar { background-color: #f0f0f0; padding: 20px; border-radius: 6px; }
    .step-item { margin-bottom: 15px; padding: 10px; border-radius: 4px; }
    .step-item.active { background-color: #e6e6e6; border-left: 5px solid #F9850A; }
    .step-item .icon { display: inline-block; width: 25px; height: 25px; background-color: #F9850A;
      border-radius: 50%; margin-right: 10px; text-align: center; line-height: 25px; color: white; font-weight: bold; }
    .form-section { display: none; }
    .form-section.active { display: block; }
  </style>
</head>

<body>
  <div class="container signup-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="header-logo">Food Metrics</h1>
      <a id="backBtn" class="link-cancel" href="javascript:void(0)"> <i class="bi bi-arrow-left"></i>  Back to Login</a>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="sidebar">
          <h2 class="mb-3">Sign Up for Free Today!</h2>
          <p class="text-muted small">
            Unlock actionable foodservice insights with Petpooja Food Metrics.
          </p>

          <div id="sidebar-steps">
            <div class="step-item active" data-step="1">
              <span class="icon">1</span>
              <strong>Organization Details</strong>
            </div>
            <div class="step-item" data-step="2">
              <span class="icon">2</span>
              <strong>Personal Details</strong>
            </div>
            <div class="step-item" data-step="3">
              <span class="icon">3</span>
              <strong>Set Password</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <form id="signupForm" method="post" novalidate>
          {% csrf_token %}
          <!-- Step 1 -->
          <div id="step-1" class="form-section active">
            <h4>Organization Details</h4>
            <div class="mb-3">
              <label for="companyName" class="form-label">Company Name</label>
              <input type="text" class="form-control" id="companyName" name="companyName">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="companyUrl" class="form-label">Company URL</label>
                <input type="url" class="form-control" id="companyUrl" name="companyUrl">
              </div>
              <div class="col-md-6 mb-3">
                <label for="numEmployees" class="form-label">Number of Employees</label>
                <input type="number" class="form-control" id="numEmployees" name="numEmployees" min="0">
              </div>
            </div>
            <div class="mb-3">
              <label for="companyAddress" class="form-label">Company Address</label>
              <input type="text" class="form-control" id="companyAddress" name="companyAddress">
            </div>
            <button type="button" class="btn btn-primary float-end login-btn" onclick="nextStep(1)">Next</button>
          </div>

          <!-- Step 2 -->
          <div id="step-2" class="form-section">
            <h4>Personal Details</h4>
            <div class="mb-3">
              <label for="username" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="phone_number" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone_number" required pattern="[6-9][0-9]{9}" title="Enter a valid 10-digit Indian mobile number">

              </div>
              <div class="col-md-6 mb-3">
                <label for="emailId" class="form-label">Email ID</label>
                <input type="email" class="form-control" id="emailId" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="jobTitle" class="form-label">Job Title</label>
              <input type="text" class="form-control" id="jobTitle" name="jobTitle">
            </div>
            <button type="button" class="btn btn-primary login-btn" onclick="prevStep(2)">Back</button>
            <button type="button" class="btn btn-primary float-end login-btn" onclick="nextStep(2)">Next</button>
          </div>

          <!-- Step 3 -->
          <div id="step-3" class="form-section">
            <h4>Set Password</h4>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="newPassword" value="Mypassword@123" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirm Password</label>
              <input type="password" class="form-control" id="confirmPassword" value="Mypassword@123"  required>
            </div>
            <button type="button" class="btn btn-primary login-btn" onclick="prevStep(3)">Back</button>
            <button type="submit" class="btn btn-primary float-end login-btn" onclick="nextStep(3)">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    const form = document.getElementById('signupForm');
  
    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = "{% url 'login-page' %}";
    });
  
    // Update UI for current step
    function updateStepUI(step) {
      document.querySelectorAll('.step-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.step) === step);
      });
  
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
      });
  
      const section = document.getElementById(`step-${step}`);
      if (section) {
        section.classList.add('active');
        section.style.display = 'block';
        currentStep = step;
        console.log("Current section ::", section);
      }
    }
  
    // Validate current step
    function validateStep(step) {
      let isValid = true;
      let errors = [];
      const section = document.getElementById(`step-${step}`);
  
      section.querySelectorAll('input[required]').forEach(input => {
        if (!input.value.trim()) {
          isValid = false;
          errors.push(`${input.previousElementSibling.textContent} is required.`);
        }
      });
  
      if (step === 2) {
        const email = document.getElementById('emailId').value.trim();
        const phone = document.getElementById('phone_number').value.trim();
  
        if (!/\S+@\S+\.\S+/.test(email)) {
          isValid = false;
          errors.push('Please enter a valid Email ID.');
        }
        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(phone)) {
          isValid = false;
          errors.push('Please enter a valid 10-digit Indian mobile number starting with 6,7,8, or 9.');
        }
      }
  
      if (step === 3) {
        const pass = document.getElementById('newPassword').value.trim();
        const confirm = document.getElementById('confirmPassword').value.trim();
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#^()_+])[A-Za-z\d@$!%*?&#^()_+]{8,}$/;
  
        if (!regex.test(pass)) {
          isValid = false;
          errors.push('Password must include upper, lower, number, special char, and be at least 8 characters long.');
        }
        if (pass !== confirm) {
          isValid = false;
          errors.push('Password and Confirm Password do not match.');
        }
      }
  
      if (!isValid) {
        Swal.fire({
          icon: 'error',
          title: 'Validation Error',
          html: `<ul style="text-align:left;">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`,
          confirmButtonColor: '#F9850A'
        });
      }
  
      return isValid;
    }
  
    // Move to next step
    function nextStep(step) {
      if (validateStep(step)) {
        if (step < 3) updateStepUI(step + 1); // Only move to next step if < 3
      }
    }
  
    // Move to previous step
    function prevStep(step) {
      if (step > 1) updateStepUI(step - 1);
    }
  
    // AJAX Submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
  
      if (!validateStep(3)) return; // Validate step 3 before submit
  
      const data = {
        company_name: document.getElementById('companyName').value,
        company_url: document.getElementById('companyUrl').value,
        num_employees: document.getElementById('numEmployees').value,
        company_address: document.getElementById('companyAddress').value,
        username: document.getElementById('username').value,
        phone_number: document.getElementById('phone_number').value,
        email: document.getElementById('emailId').value,
        job_title: document.getElementById('jobTitle').value,
        password: document.getElementById('newPassword').value,
      };
  
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
      try {
        const response = await fetch("{% url 'signup' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
          },
          body: JSON.stringify(data)
        });
  
        const result = await response.json();
  
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Sign Up Successful!',
            text: result.message || 'Verify your account.',
            confirmButtonColor: '#28a745'
          // }).then(() => window.location.href = "{% url 'verify-otp' %}");
        }).then(() => {
          const phoneNumber = encodeURIComponent(document.getElementById('phone_number').value);
          window.location.href = `{% url 'verify-otp' %}?phone=${phoneNumber}`;
        });
        } else {
          // Display field-level errors as bullets
          let errorMsg = '';
          if (typeof result === 'object') {
            errorMsg = '<ul style="text-align:left;">' +
                Object.keys(result).map(key =>
                `<li>${key} : ${Array.isArray(result[key]) ? result[key].join(' ') : result[key]}</li>`
                ).join('') +
                '</ul>';
           } else {
                errorMsg = result.message || result.error || result.detail || 'Something went wrong.';
            }
  
          Swal.fire({
            icon: 'error',
            title: 'Sign Up Failed',
            html: errorMsg
          });
        }
      } catch (err) {
        console.log("err :", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Server not responding. Please try again later.'
        });
      }
    });
  
    // Initialize UI
    updateStepUI(1);
  </script>
  
  
</body>
</html>
